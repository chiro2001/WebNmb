function showImageGallery(){if(gallery.src){var a=D("gallery-section"),b=a.querySelector(".swipe-wrap"),c=a.querySelector("header"),d=gallery.threadPerPage,e=gallery.totalPage,f=gallery.firstPage-1<0?0:gallery.firstPage-1,g=gallery.src,h=gallery.dataFolder,i=3,j="",k=g&&g.substr(g.lastIndexOf("/")+1),l=!1,m=!1,n=!1,o=void 0!==document.body.style.webkitFilter,p=function(){this.onload=null,this.classList.remove("image-error"),this.classList.remove("image-loading");var a=this.parentNode;if(a){var b=a.querySelector("p");if(b&&a.removeChild(b),gallery.nightMode&&!o){var c=a.id,d=document.createElement("style");d.textContent="#"+c+":before{height:"+a.scrollHeight+"px;}",a.appendChild(d)}}},q=function(){this.onerror=null;var a=this.parentNode;if(a){var b=a.querySelector("p");b&&a.removeChild(b)}H.Util.reloadImage(this)},r=function(a){var c=document.createDocumentFragment();a.forEach(function(a){a.indexOf("http:")<0&&a.indexOf("https:")<0&&a.indexOf("file:")<0&&(a=h?h+"/images/"+a:Current.api.cdn[0]+"/image/"+a);var b=document.createElement("div");b.className="image-holder needsclick"+(o?"":" mask"),b.id="image-holder"+ ++count,b.setAttribute("full-size-src",a),c.appendChild(b)}),b.appendChild(c)},s=function(a){if(a&&!a.querySelector("img")){var b=document.createElement("img"),c=a.getAttribute("full-size-src");b.setAttribute("src",c),b.classList.add("needsclick"),b.onload=p,b.onerror=q;var d=document.createElement("p");d.textContent="加载中...";var e=document.createElement("span");a.appendChild(d),a.appendChild(e),a.appendChild(b)}},t=function(a){if(mySwiper&&!(2>a)){var b=mySwiper.getNumSlides(),c=a-2,d=a+2,e=[];if(c>=0){var f=mySwiper.slides[c],g=f.querySelector("img");g&&e.push(g)}if(b-1>=d){var f=mySwiper.slides[d],g=f.querySelector("img");g&&e.push(g)}[].slice.call(e).forEach(function(a){a.setAttribute("src","data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs="),a.parentNode&&empty(a.parentNode),a=null}),e=null}},u=function(c,i){var l=c.replys||[],m=h&&c.fileName||c.img+c.ext,o=[];if(m&&(j||(j=m,o.push(m))),i){l=[];for(var p in gallery.cache){var q=gallery.cache[p]||{},t=!1;q.replys=q.replys||[];for(var u=0;u<q.replys.length;u++){var v=q.replys[u].img+q.replys[u].ext;if(v.substr(v.lastIndexOf("/")+1)==k&&v!=j){gallery.firstPage=parseInt(p,10),f=gallery.firstPage-1<0?0:gallery.firstPage-1,t=!0;break}}if(l=l.concat(q.replys||[]),t)break}0===l.length&&(l=c.replys||[])}l.forEach(function(a){if(h&&a.fileName&&a.fileName!=k)o.push(a.fileName);else if(a.img){var b=a.img+a.ext;o.push(b)}}),o=H.Util.uniqueArray(o);var t=o.some(function(a){return a.substr(a.lastIndexOf("/")+1)==k});t||n||o.unshift(g),n=!0;var w=0;o.forEach(function(a,b){a.substr(a.lastIndexOf("/")+1)==k&&(w=b)}),console.log(w),r(o),f+=1,e=Math.ceil(c.replyCount/d),0!=o.length||f===gallery.firstPage&&gallery.continuous||H.Util.toast.show(f+1>e?"已是最后一页":"Page "+f+" 无图"),0==o.length&&f==gallery.firstPage&&(b.querySelector(".image-holder")||r([g])),mySwiper&&(mySwiper.setup(w),a.querySelector(".title").textContent=mySwiper.getPos()+1+" / "+mySwiper.getNumSlides(),w>=0&&o.length>0&&s(b.querySelector('[data-index="'+w+'"]')))},v=function(a){var b=f+1;if(b>e)return void H.Util.toast.show("已是最后一页");var c=function(a){console.error(a),m=!1,H.Util.toast.show("加载下一页失败")};if(h)return void H.Util.readFile(h+"/data/"+b+".data").then(function(a){a=a.toString();var b=a.indexOf("("),d=a.lastIndexOf(")");a=a.substring(b+1,d);try{a=JSON.parse(a),a=H.Util.backwardCompatible(a)}catch(e){return void c()}u(a)},c);if(gallery.cache[b])u(gallery.cache[b],a);else{if(m)return void H.Util.toast.show("加载中...");m=!0,H.Util.toast.show("正在加载Page "+b+"...");{H.Xhr.get(Current.api.thread,{id:gallery.threadid,page:b,appid:Current.appid},{responseType:"json",timeout:3e4}).then(function(a){if(!(a instanceof Object))throw a;m=!1,u(a)})["catch"](c)}}};"ios"!=H.Util.device.platform&&a.querySelector(".content").addEventListener("touchstart",function(a){var b=c.getAttribute("data-position");"current"==b?(toggleSection(c,"top"),c.setAttribute("data-cancelled",!0)):c.setAttribute("data-cancelled","")}),a.onclick=function(a){var b=a.target,d=b.classList,e=b.tagName.toLowerCase(),f=(b.id,mySwiper.getPos()),g=mySwiper.slides[f].querySelector("img"),h=g.src,i=h.substr(h.lastIndexOf("/")+1);if(d.contains("btn-back"))close();else if(d.contains("btn-save-image")){var j=this;if(j.disabled=!0,"ios"==H.Util.device.platform){d.add("active-fix"),setTimeout(function(){d.remove("active-fix")},200);try{H.Util.toast.show("正在保存..."),cordova.plugins.saveToPhotoAlbum.save(h,function(a){j.disabled=!1,H.Util.toast.show("图片保存成功")},function(a){j.disabled=!1,window.plugins.socialsharing.share(null,null,h,null)})}catch(k){j.disabled=!1,window.plugins.socialsharing.share(null,null,h,null)}}else{H.Xhr.get(h,null,{responseType:"arraybuffer",timeout:6e4,cache:!0}).then(function(a){j.disabled=!1,H.Util.saveToStorage(a,gallery.storageFolder+"/image/"+i).then(function(){H.Util.toast.show("图片已保存在nimingban/image")},function(){H.Util.toast.show("图片保存失败")})})["catch"](function(a){j.disabled=!1,console.error(a),H.Util.toast.show("图片保存失败")})}}else if(d.contains("btn-share"))window.plugins.socialsharing.share(h,"#A岛#图片分享",h,null);else{var l=c.getAttribute("data-cancelled");if(l)c.setAttribute("data-cancelled","");else{var m=window.innerWidth;m>=Math.floor(.98*initialWidth)&&initialWidth>=m&&toggleSection(c,"current")}("img"==e||d.contains("image-holder"))&&(d.contains("image-error")?H.Util.reloadImage(b,!0):"ios"==H.Util.device.platform&&close())}},gallery.continuous||(gallery.screenshots=gallery.screenshots||[],r([g].concat(gallery.screenshots)),s(b.querySelector(".image-holder"))),mySwiper=new Swipe(D("swipe"),{auto:!1,continuous:!1,stopPropagation:!1,endCallback:function(a,b,c){c&&(m?H.Util.toast.show("加载中..."):v())},callback:function(b,c,d){b+1>=i&&!l&&(l=!0);var e=mySwiper.getNumSlides();if(a.querySelector(".title").textContent=b+1+" / "+e,t(b),s(c),l){var f=d?mySwiper.slides[b+1]:mySwiper.slides[b-1];f&&s(f)}}}),a.querySelector(".title").textContent="1 / "+mySwiper.getNumSlides(),gallery.continuous&&v(!0),toggleSection(c,"current")}}function toggleSection(a,b){"top"==b||"right"==b||"left"==b||"bottom"==b?(a.setAttribute("data-position",b),setTimeout(function(){a.style.display="none",a=null},400)):"current"==b&&(a.style.display="block",setTimeout(function(){a.setAttribute("data-position",b),a=null},30))}function close(){setTimeout(function(){localStorage.setItem("action","close"),webview.close()},"android"==H.Util.device.platform&&H.Util.device.version<44?300:"ios"==H.Util.device.platform?30:100)}function empty(a){for(;a.firstChild;)a.removeChild(a.firstChild)}var D=function(a){return document.getElementById(a)},gallery=localStorage.getItem("gallery");gallery=gallery&&JSON.parse(gallery)||{};var Current=gallery.current||H.Nimingban[gallery.site];H.Current=Current;var initialWidth=window.innerWidth,count=0;FastClick.attach(D("gallery-header")),document.addEventListener("deviceready",function(){initialWidth=window.innerWidth,window.StatusBar&&(gallery.nightMode?(StatusBar.styleLightContent(),StatusBar.backgroundColorByHexString("#000000")):(StatusBar.styleDefault(),StatusBar.backgroundColorByHexString("#009688"))),showImageGallery()}),window.addEventListener("resize",function(){initialWidth=window.innerWidth}),window.addEventListener("DOMContentLoaded",function(){gallery.nightMode&&document.body.classList.add("night-mode")});